
# 浏览器搜索边栏插件 — 开发需求（简洁版）

## 一句话概述

在支持的搜索引擎页面左侧显示一个可展开的边栏（初始为细线），展示可用搜索引擎列表并允许用户切换搜索方式。边栏只在配置的搜索引擎域名上显示，支持在插件设置中增删改搜索引擎与导入/导出配置。

## 目标用户

目标浏览器：Chromium 系（Chrome / Edge）与 Firefox（均需支持，注意两者在 manifest/API 上存在差异，需在实现时处理）。

## 设计原则（简单直观）

- 小而专：只在配置的搜索引擎页面显示边栏，不影响页面主体布局。
- 快速响应：边栏交互与渲染要流畅。
- 可配置：通过设置页面管理搜索引擎与导出/导入配置。

## 功能要求（逐条、可实现）

1. 显示条件
	- 仅在 data.json 的 `listData` 中配置的搜索引擎页面显示边栏（匹配域名或 URL 模板）。

2. 边栏外观与交互
	- 默认状态：页面左侧一条垂直的细线（edge-line）。
	- 鼠标悬停/聚焦：细线向右滑出，展开完整边栏（宽度可配置，默认 320px）。
	- 鼠标移出：恢复为细线。
	- 列表按组显示（group），每组有标题，标题左侧有图标。每一个搜索引擎条目左侧也有图标（可设置显示或隐藏），通过`<img src="https://favicon.im/{目标url}" alt="{目标名称}" />`来获取
	- 当前页面对应的搜索引擎项高亮（在细线态仍需有可视提示）。

3. 切换搜索引擎与提取关键词
    - 点击列表项时，插件从当前页面提取关键词（优先：选中内容 → 指定搜索框值（可配置 querySelector）→ 页面 title），然后用所选引擎在当前页进行搜索。默认行为为在当前页打开（替换 window.location）；可在设置中改为在新标签打开。

4. 设置页（Options）
    - 列表管理：增、删、改、排序、分组一个或多个搜索引擎条目。每条目包含：名称 `name`、搜索 URL 模板 `urlTemplate`（使用占位符 `{keyword}`）、匹配规则 `match`（必填，用户可修改）。
    - 全局设置：边栏宽度、默认展开行为（hover / click）、搜索打开方式（当前页 / 新标签，默认：当前页）、是否显示图标等。
    - 关键词提取可为每个引擎指定 `querySelector`，优先级高于自动检测。
	- 导入/导出：以 JSON 文件导入或导出完整配置（含 `listData` 与 `setting`）。

5. 数据来源与结构（示例契约）
    - data.json（或 extension.storage）结构示例（说明：所有引擎项必须包含 `match` 字段，可由导入的默认值提供，也可由 UI 让用户修改）：

```json
{
  "setting": {
    "showIcon": false,
    "openInNewTab": false
  },
    "listData": [
    {
      "name": "开发",
      "icon": "💻",
      "items": [
        {"name":"GitHub", "urlTemplate":"https://github.com/search?utf8=✓&q={keyword}"},
        {"name":"MDN", "urlTemplate":"https://developer.mozilla.org/zh-CN/search?q={keyword}"},
        {"name":"Stack Overflow", "urlTemplate":"https://stackoverflow.com/search?q={keyword}"},
        {"name":"掘金", "urlTemplate":"https://juejin.im/search?query={keyword}&type=all"}
      ]
    },
    {
      "name": "搜索",
      "icon": "😀",
      "items": [
        {"name":"Google", "urlTemplate":"https://www.google.com/search?q={keyword}"},
        {"name":"Bing", "urlTemplate":"https://www.bing.com/search?q={keyword}"},
        {"name":"百度", "urlTemplate":"https://www.baidu.com/s?wd={keyword}"},
        {"name":"DuckDuckGo", "urlTemplate":"https://duckduckgo.com/?q={keyword}"}
      ]
    },
    {
      "name": "视频",
      "icon": "🎦",
      "items": [
        {"name":"哔哩哔哩", "urlTemplate":"https://www.bilibili.com/search?keyword={keyword}"},
        {"name":"YouTube", "urlTemplate":"https://www.youtube.com/results?search_query={keyword}"}
      ]
    },
    {
      "name": "学术",
      "icon": "🎓",
      "items": [
        {"name":"Google Scholar", "urlTemplate":"https://scholar.google.com/scholar?q={keyword}"},
        {"name":"中国知网", "urlTemplate":"https://kns.cnki.net/kns8s/defaultresult/index?kw={keyword}"},
        {"name":"万方", "urlTemplate":"https://s.wanfangdata.com.cn/paper?q={keyword}"},
        {"name":"Semantic Scholar", "urlTemplate":"https://www.semanticscholar.org/search?q={keyword}&sort=relevance"},
        {"name":"DBLP", "urlTemplate":"https://dblp.org/search?q={keyword}"},
        {"name":"arXiv", "urlTemplate":"https://arxiv.org/search/?query={keyword}&searchtype=all&source=header"},
        {"name":"IEEE Xplore", "urlTemplate":"https://ieeexplore.ieee.org/search/searchresult.jsp?newsearch=true&queryText={keyword}"},
        {"name":"ACM Digital Library", "urlTemplate":"https://dl.acm.org/action/doSearch?AllField={keyword}"}
      ]
    }
  ]
}
```

  注：示例中 `urlTemplate` 使用 `{keyword}` 占位符（实现时对关键词使用 encodeURIComponent 编码）。

  关于 `match`（自动推断与使用规则，简洁说明）：

  - 目的：为了让 data.json 更精简，`match` 在示例里可以省略。扩展在导入或首次加载时会根据 `urlTemplate` 自动推断一个合理的 `match`，并把推断结果保存到扩展配置中。推断结果仅作为默认值，用户可在 Options 中修改。

  - 推断策略（实现建议，足够简单且实用）：
    1. 若 `urlTemplate` 是完整绝对 URL（以 http:// 或 https:// 开头），从中解析出协议、主机与可选端口（例如 `https://www.example.com:3000/...` → protocol=https, host=www.example.com, port=3000）。
    2. 生成默认匹配：`{protocol}://{host}{:port}/*`（例如 `https://www.example.com/*` 或 `http://localhost:3000/*`）。
    3. 提供可选宽松模式：将首标签去除并生成 `https://*.{rootDomain}/*`（例如 `https://*.google.com/*`），作为可选模式供用户选择。默认使用严格模式（精确 host），以减少误匹配。
    4. 如果 `urlTemplate` 缺少协议或为相对路径（例如 `/search?q={keyword}`），无法从模板推断出 host，此时扩展应使用运行时注入（activeTab / scripting.executeScript）或提示用户在 Options 中手动指定 `match`。

  - 细节与注意事项：
    - 默认倾向使用 https 协议；仅当模板明确为 http 时使用 http。
    - 若存在端口号，应将端口包含在 match 模式中。
    - 对于复杂或动态模板（不含主机信息或使用占位符替换主机），推断可能失败，扩展应把该条目标记为“需人工确认”。
    - 推断算法是一个便利功能，不用于安全决策；所有推断后的 `match` 都可被用户在 Options 中编辑。

  示例（省略 `match` 时的 data.json）：

```json
{
  "setting": { "showIcon": false, "openInNewTab": false },
  "listData": [
    {
      "name": "开发",
      "icon": "💻",
      "items": [
        {"name":"GitHub", "urlTemplate":"https://github.com/search?utf8=✓&q={keyword}"},
        {"name":"MDN", "urlTemplate":"https://developer.mozilla.org/zh-CN/search?q={keyword}"},
        {"name":"Stack Overflow", "urlTemplate":"https://stackoverflow.com/search?q={keyword}"}
      ]
    }
  ]
}
```

  推断示例：
  - `https://github.com/...` → 默认 match: `https://github.com/*`
  - `http://localhost:3000/...` → 默认 match: `http://localhost:3000/*`
  - `/search?q={keyword}`（相对路径）→ 无法推断 host，建议使用运行时注入或手动在 Options 指定 `match`。

6. 性能与边界
	- 仅在匹配页面注入 content script，避免不必要的注入。
	- DOM 操作应尽量轻量，使用 CSS transform/transition 做动画。

7. 权限（最小化）
	- "storage"：保存设置。
	- "activeTab" 或 特定主机权限（根据需要使用 host 权限匹配 listData）。
	- 如果使用 manifest v3：background 为 service worker。

8. 安全性
	- 不注入任意外部脚本。外部图标或模板 URL 仅在设置中显示并作为可选项，不自动执行。

## 技术实现建议

- Manifest v3（推荐）
- Content script：注入边栏 DOM、处理悬停/展开动画、从页面提取关键词并与 background 或直接操作 window.location 通信。
- Background/service worker：处理导入/导出、持久化、跨域网络请求（若需要）、右键或快捷键命令（可选）。
- Options 页面：使用 Vue（已在项目中声明），通过 chrome.storage 与扩展共享配置。
- 构建：node + pnpm，打包工具可使用 Vite（与 Vue 搭配）以生成 options/popup 静态资源。

## 验收标准（可自动测试/验证）

1. 在 `listData` 中配置的某搜索引擎域名打开时，页面左侧出现细线边栏。
2. 悬停后边栏展开并展示分组与引擎列表，且展开/收起动画流畅。
3. 点击一个引擎后按配置在当前页或新标签打开搜索结果，且关键词提取优先级正确。
4. 在设置页能增删改引擎并保存在 storage，中断浏览器后重启仍生效。
5. 能成功导入/导出 JSON 配置且格式一致。

## 最小实现文件清单（供 agent 生成）

- manifest.json
- src/content/sidebar.ts(x) — content script，负责渲染边栏与交互
- src/background/service-worker.ts — 处理存储、消息与导入导出
- src/options/*.vue — 设置页（Vue + Vite）
- data.json（示例配置，可内置在扩展或作为默认 resource）
- README.md（使用/开发说明）

## 开发优先级（建议迭代）

1. 基础边栏显示与 hover 展开（content script）+ 简单 data.json
2. 点击触发搜索（关键词提取、URL 模板替换）
3. Options 页面：增删改保存（storage）
4. 导入/导出与性能优化（路由监听）
5. UX 微调、图标与分组折叠

## 假设与备注（如果需要 agent 自动生成代码时请确认）

- 目标浏览器：Chromium（Chrome/Edge）与 Firefox（均需支持，注意 Firefox 对部分 Manifest v3 特性的兼容性；实现时需要针对 Firefox 调整 manifest 或运行时兼容层）。
- 使用 Manifest V3 为首选方案，但为兼容 Firefox 可能需要额外适配或使用 polyfill。


---

如果你同意这个结构，我可以：

1) 把这个文档写入当前 `开发需求.md`（已完成）。
2) 接着为第一阶段（基础边栏）生成最小可运行的代码结构与示例实现（manifest + content script + 简单 data.json + 打包说明）。

请选择下一步：生成代码骨架，或先对文档细节做进一步修改。 
